{% extends 'layout.html.twig' %}

{% block title %}Patient - {{ patient.givenName }} {{ patient.familyName }}{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('fhir_portal_index') }}">Accueil</a></li>
            <li class="breadcrumb-item active">Patient</li>
        </ol>
    </nav>
    
    <div class="row">
        <div class="col-md-8">
            <h1>{{ patient.givenName }} {{ patient.familyName }}</h1>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Informations générales</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Identifiant:</strong> {{ patient.identifier }}</p>
                            <p><strong>Nom:</strong> {{ patient.familyName }}</p>
                            <p><strong>Prénom:</strong> {{ patient.givenName }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date de naissance:</strong> {{ patient.birthDate ? patient.birthDate|date('d/m/Y') : '-' }}</p>
                            <p><strong>Genre:</strong> 
                                {% if patient.gender == 'male' %}
                                    <i class="fas fa-mars text-primary"></i> Masculin
                                {% elseif patient.gender == 'female' %}
                                    <i class="fas fa-venus text-danger"></i> Féminin
                                {% else %}
                                    {{ patient.gender|default('-') }}
                                {% endif %}
                            </p>
                            <p><strong>Âge:</strong> 
                                {% if patient.birthDate %}
                                    {{ "now"|date('Y') - patient.birthDate|date('Y') }} ans
                                {% else %}
                                    -
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Contact</h5>
                </div>
                <div class="card-body">
                    <p><strong>Téléphone:</strong> {{ patient.phone|default('-') }}</p>
                    <p><strong>Email:</strong> {{ patient.email|default('-') }}</p>
                    <p><strong>Adresse:</strong> {{ patient.address|default('-') }}</p>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Observations récentes</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadObservations()">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
                <div class="card-body">
                    <div id="observations-list">
                        <p class="text-muted">Chargement des observations...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary w-100 mb-2" onclick="showFhirJson()">
                        <i class="fas fa-code"></i> Voir JSON FHIR
                    </button>
                    <a href="/admin" class="btn btn-secondary w-100 mb-2">
                        <i class="fas fa-edit"></i> Modifier
                    </a>
                    <button class="btn btn-info w-100" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Métadonnées</h5>
                </div>
                <div class="card-body">
                    <p><small><strong>ID Pimcore:</strong> {{ patient.id }}</small></p>
                    <p><small><strong>Créé le:</strong> {{ patient.creationDate|date('d/m/Y H:i') }}</small></p>
                    <p><small><strong>Modifié le:</strong> {{ patient.modificationDate|date('d/m/Y H:i') }}</small></p>
                    <p><small><strong>Version:</strong> {{ patient.versionCount }}</small></p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="fhirJsonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Représentation FHIR (JSON)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="fhir-json-content" class="bg-light p-3"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="copyToClipboard()">
                    <i class="fas fa-copy"></i> Copier
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
function loadObservations() {
    const container = document.getElementById('observations-list');
    container.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Chargement...';
    
    fetch('{{ path('fhir_api_list', {resourceType: 'Observation'}) }}?patient={{ patient.id }}')
        .then(response => response.json())
        .then(data => {
            displayObservations(data);
        })
        .catch(error => {
            container.innerHTML = '<p class="text-danger">Erreur lors du chargement des observations</p>';
        });
}

function displayObservations(bundle) {
    const container = document.getElementById('observations-list');
    
    if (!bundle.entry || bundle.entry.length === 0) {
        container.innerHTML = '<p class="text-muted">Aucune observation trouvée</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    
    bundle.entry.forEach(entry => {
        const obs = entry.resource;
        html += '<div class="list-group-item">';
        html += `<div class="d-flex w-100 justify-content-between">`;
        html += `<h6 class="mb-1">${obs.code?.text || obs.display || 'Observation'}</h6>`;
        html += `<small>${obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleDateString('fr-FR') : ''}</small>`;
        html += `</div>`;
        
        if (obs.valueQuantity) {
            html += `<p class="mb-1"><strong>Valeur:</strong> ${obs.valueQuantity.value} ${obs.valueQuantity.unit || ''}</p>`;
        } else if (obs.valueString) {
            html += `<p class="mb-1"><strong>Valeur:</strong> ${obs.valueString}</p>`;
        }
        
        html += `<small class="text-muted">Code: ${obs.code?.coding?.[0]?.code || '-'}</small>`;
        html += '</div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function showFhirJson() {
    fetch('{{ path('fhir_api_read', {resourceType: 'Patient', id: patient.id}) }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('fhir-json-content').textContent = JSON.stringify(data, null, 2);
            const modal = new bootstrap.Modal(document.getElementById('fhirJsonModal'));
            modal.show();
        })
        .catch(error => {
            alert('Erreur lors du chargement du JSON FHIR');
        });
}

function copyToClipboard() {
    const content = document.getElementById('fhir-json-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('JSON copié dans le presse-papiers !');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadObservations();
});
</script>
{% endblock %}